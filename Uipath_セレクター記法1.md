
---

### 1. セレクターの基本構造

セレクターは、XMLという言語に似た形式で記述されます。`<タグ名 属性名='値' />` のように、**タグ**と**属性**の組み合わせで構成されています。

*   **UI（ユーザーインターフェース）**: 人間がコンピューターを操作するための画面や、その中にあるボタン、メニューなどの部品全体を指します。
*   **タグ**: UI要素の種類を表します。どのような種類の部品かを示します。
    *   `<wnd>`: ウィンドウ（アプリケーションの画面全体）
    *   `<webctrl>`: Webページの要素（ボタン、リンク、入力欄など）
    *   `<ctrl>`: デスクトップアプリケーションの部品（ボタン、チェックボックスなど）
*   **属性**: UI要素が持つ具体的な特徴（情報）です。名前、ID、表示されているテキストなど、要素を特定するための手がかりとなります。
    *   `app`: アプリケーションの実行ファイル名（例: `chrome.exe`, `excel.exe`）
    *   `title`: ウィンドウやWebページのタイトル
    *   `aaname`: アクセシビリティ名。画面に表示されているテキストラベルであることが多く、非常に信頼性の高い属性です。
    *   `cls`: ウィンドウクラス名。OSがウィンドウを管理するために使う内部的な名前です。
    *   `tag`: HTMLタグの種類（例: `INPUT`, `DIV`, `A`）
    *   `id`: HTML要素に付けられた一意のID。
    *   `name`: HTML要素に付けられた名前。

#### 階層構造

セレクターは、UI要素の親子関係を反映した**階層構造**になっています。これは「東京都 > 渋谷区 > 道玄坂」のように、大きな範囲から絞り込んでいく住所の考え方と似ています。

**【例】Google検索画面の検索ボックスのセレクター**

```xml
<wnd app='chrome.exe' cls='Chrome_WidgetWin_1' title='Google - Google Chrome' />
<webctrl tag='INPUT' type='text' aaname='検索' />
```

このセレクターは、以下のような意味になります。

1.  `<wnd ... />`: まず、`chrome.exe`というアプリの、タイトルが`Google - Google Chrome`であるウィンドウを探します。
2.  `<webctrl ... />`: そのウィンドウの中で、HTMLタグが`INPUT`で、`type`が`text`、画面上の表示テキスト（`aaname`）が`検索`である要素を探します。

このように、上から順に対象を絞り込んでいくことで、目的のUI要素を正確に特定します。

---

### 2. フルセレクターと部分セレクター

セレクターには、記述範囲によって2つの種類があります。

#### フルセレクター (Full Selector)
ウィンドウ情報（`<wnd>`など）から始まる、**完全なパスを持つセレクター**です。どのウィンドウのどの要素か、という情報がすべて含まれています。

*   **特徴**: 単独でUI要素を特定できます。
*   **使われる場面**: `クリック`や`文字を入力`などのアクティビティを、`ブラウザーを開く`などのコンテナー（範囲を指定するアクティビティ）の外で使う場合。

**【例】**
```xml
<wnd app='chrome.exe' title='Google' />
<webctrl tag='A' aaname='Gmail' />
```

#### 部分セレクター (Partial Selector)
`ブラウザーにアタッチ`や`ウィンドウにアタッチ`といったコンテナーアクティビティの**中で使われる、省略されたセレクター**です。コンテナーがすでにウィンドウを特定しているため、セレクターにはウィンドウ以下の情報だけを記述します。

*   **特徴**: コンテナー内で動作するため、ウィンドウ情報が省略されています。
*   **使われる場面**: `ブラウザーにアタッチ`などのコンテナーの中でアクティビティを使う場合。**こちらを使うことが推奨されます。**

**【例】**
`ブラウザーにアタッチ`アクティビティのセレクター: `<wnd app='chrome.exe' title='Google' />`

その中の`クリック`アクティビティのセレクター（部分セレクター）:
```xml
<webctrl tag='A' aaname='Gmail' />
```

**なぜ部分セレクターが推奨されるのか？**
複数の操作を同じウィンドウで行う場合、操作ごとにフルセレクターを記述すると、もしウィンドウのタイトルが変わった際にすべてのセレクターを修正する必要があり、メンテナンスが大変です。
一方、コンテナーと部分セレクターを使えば、**コンテナーのセレクターを1つ修正するだけで済む**ため、メンテナンス性が大幅に向上します。

---

### 3. セレクターを自在に操る記法

静的な（変化しない）画面では自動生成されたセレクターで十分ですが、実際の業務では動的に変化する画面を扱うことが多々あります。その際に役立つのが以下の記法です。

#### 3.1. ワイルドカード - あいまい検索

セレクターの一部が毎回変わってしまう場合、ワイルドカードを使うことで柔軟に対応できます。

*   **アスタリスク (`*`)**: **0文字以上の任意の文字列**に一致します。
    *   **用途**: ファイル名の日付や、ユーザー名など、可変部分を無視したい場合。
    *   **例**: `title='請求書 2023-10-26.xlsx'` というタイトルがあった場合、日付部分を`*`に置き換えます。
        ```xml
        <wnd app='excel.exe' title='請求書*.xlsx' />
        ```
        これで、`請求書 2023-11-01.xlsx`や`請求書 ABC.xlsx`などにも一致します。

*   **クエスチョンマーク (`?`)**: **任意の1文字**に一致します。
    *   **用途**: 文字数は決まっているが、具体的な文字が不明または変化する場合。
    *   **例**: `請求書No.1` `請求書No.2` ... のように一桁の数字が変わる場合。
        ```xml
        <ctrl name='請求書No.?' role='text' />
        ```

#### 3.2. 変数 - 動的な値を埋め込む

RPAの処理の中で取得した値（例えば、今日の日付や処理対象の顧客名）をセレクターに含めたい場合、変数を使います。

*   **記法**: `{{変数名}}` のように、変数を二重の中括弧で囲みます。
*   **用途**: ループ処理で毎回異なる製品ページを開く場合や、その日の日付が入ったファイルを開く場合など。
*   **例**: `targetCustomerName`という変数に顧客名（例: "株式会社A"）が格納されているとします。
    ```xml
    <wnd app='chrome.exe' title='{{targetCustomerName}} - 顧客情報' />
    ```
    Studioのセレクターエディターで右クリックし、「変数を選択」から挿入することもできます。

#### 3.3. インデックス (`idx`) - 同じ見た目の要素を区別

画面上に、見た目もセレクターの属性も全く同じ要素が複数存在することがあります（例: 表の中の同じ名前のボタン）。その場合、UiPathは内部的に上から（または左から）順番に番号を振り、`idx`属性を使って区別します。

*   **記法**: `idx='番号'` (番号は1から始まります)
*   **例**:
    ```xml
    <webctrl tag='INPUT' type='button' aaname='詳細' idx='3' />
    ```
    これは、「詳細」と書かれたボタンのうち、3番目のものを指します。

*   **【超重要】`idx`は最後の手段**
    `idx`は、**UIのレイアウトが少しでも変わると簡単にずれてしまう**ため、非常に不安定です。例えば、リストの途中に新しい項目が追加されると、それ以降の`idx`はすべてずれてしまいます。
    `idx`を使わずに済むように、**他のユニークな属性を探したり、後述するアンカーベースを使ったりする**ことを強く推奨します。

---

### 4. セレクターの信頼性を高めるテクニック

#### 4.1. アンカーベース (Anchor Base)
操作したい要素自体に良い目印（属性）がない場合、その**近くにある別の信頼できる要素（ラベルなど）を目印（アンカー）にして**、相対的な位置で目的の要素を特定する手法です。

*   **例**: 「氏名」というラベルの右側にあるテキスト入力欄を操作したい。入力欄自体には良い属性がない。
    1.  `アンカーベース`アクティビティを配置します。
    2.  左側の「アンカー」に、「氏名」ラベルを指定します。
    3.  右側の「アクション」に、`文字を入力`アクティビティを配置し、テキスト入力欄を指定します。

これにより、ロボットは「まず『氏名』というラベルを探し、その近くにある入力欄に文字を入力する」という動作になり、画面レイアウトの変更に強くなります。

#### 4.2. Fuzzy Matching (あいまい一致)
セレクターのテキスト属性が、OCR（光学文字認識）の読み取りミスなどで少しだけ違う場合でも、要素を見つけられるようにする機能です。

*   **記法**: `matching:aaname='fuzzy'` のように、属性名の前に`matching:`を付け、値を`fuzzy`にします。
*   **例**: `aaname='請求書'` と完全に一致しなくても、`aaname='清求書'` のように少し違っていても一致させることができます。
*   `fuzzylevel:aaname='0.8'`のように、一致率（0から1の間の数値）を指定することも可能です。

---

### 5. UI Explorer - 最強のセレクター編集ツール

UI Explorerは、セレクターを詳細に分析・編集するための専門ツールです。

*   **起動方法**: Studioのデザインリボン（上部メニュー）から起動するか、アクティビティのプロパティでセレクターの「...」ボタンを押した先のウィンドウから開けます。

**主な機能**:
*   **ビジュアルツリー**: 画面のUI要素を階層構造で表示し、親子関係を視覚的に確認できます。
*   **セレクターエディター**: 選択したUI要素のセレクターが自動で表示されます。
*   **属性パネル**: その要素が持つすべての属性が一覧表示されます。チェックを入れたり外したりするだけで、セレクターがリアルタイムに更新され、すぐに検証できます。
*   **検証**: 作成したセレクターが、画面上の要素を正しく指し示すか（ハイライトされるか）をテストできます。**セレクターを編集したら必ず検証する癖をつけましょう。**

**UI Explorer活用のコツ**:
*   自動生成されたセレクターに、`id`や`css-selector`などのように**自動生成されたと思われる不安定な値が含まれていないか確認**し、チェックを外します。
*   代わりに、`aaname`や`name`など、**より意味のある、安定的だと思われる属性にチェックを入れます**。
*   検証ボタンを押し、ターゲットの要素だけがハイライトされる（一致する要素が1つになる）ことを確認します。

---

### 6. セレクターのベストプラクティスとトラブルシューティング

#### ベストプラクティス（まとめ）
*   **安定的で一意な属性を優先する**: `id`, `name`, `aaname`などを優先的に使いましょう。
*   **`idx`は避ける**: `idx`を使わないと特定できないか、十分に検討しましょう。
*   **動的に生成される値は避ける**: `id='uid-12345'`のような値は使わず、ワイルドカード(`*`)で置き換えましょう。
*   **部分セレクターを積極的に使う**: `ブラウザーにアタッチ`などのコンテナーを使い、メンテナンス性を高めましょう。
*   **UI Explorerで検証する**: 編集したセレクターは必ず検証し、意図通りに動作することを確認しましょう。

#### トラブルシューティング: セレクターが見つからない場合
`SelectorNotFoundException`というエラーが出た場合は、以下の点を確認してください。

1.  **タイミングの問題**: ロボットの実行が速すぎて、まだ画面要素が表示されていない可能性があります。アクティビティの`Timeout`プロパティを長くしたり、`要素の有無を検出`アクティビティで表示を待ったりしましょう。
2.  **セレクターの不一致**: UI Explorerでセレクターを検証し、どの部分が一致していないか確認します。
    *   **タイトルが変わっている**: ウィンドウタイトルに日付やユーザー名が含まれていませんか？ → ワイルドカードや変数で対応します。
    *   **属性値が変わっている**: IDなどが動的に変わっていませんか？ → ワイルドカードを使うか、その属性のチェックを外して別の安定した属性で特定します。
3.  **ウィンドウ/タブの状態**: 対象のアプリケーションやブラウザのタブが、本当に前面（アクティブ）になっていますか？
4.  **環境の違い**: 開発環境と実行環境で、画面の解像度やアプリケーションのバージョンが異なると、セレクターがずれることがあります。
